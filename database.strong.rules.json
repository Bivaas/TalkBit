{
  "rules": {
    ".read": "auth != null",
    ".write": "auth != null",

    "messages": {
      "global": {
        "$msgId": {
          ".write": "auth != null && newData.exists() && newData.child('senderId').val() === auth.uid && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length <= 2000 && newData.child('timestamp').val() <= now + 5000 && newData.child('timestamp').val() >= now - 86400000 && newData.child('hash').isString() && root.child('messageHashes').child(newData.child('hash').val()).val() == null",
          ".validate": "newData.hasChildren(['senderId','text','timestamp','chatId','chatType','hash'])"
        }
      },
      "direct": {
        "$chatId": {
          "$msgId": {
            ".write": "auth != null && newData.exists() && newData.child('senderId').val() === auth.uid && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length <= 2000 && newData.child('timestamp').val() <= now + 5000 && newData.child('timestamp').val() >= now - 86400000 && newData.child('hash').isString() && root.child('messageHashes').child(newData.child('hash').val()).val() == null",
            ".validate": "newData.hasChildren(['senderId','text','timestamp','chatId','chatType','hash','receiverId'])"
          }
        }
      }
    },

    "messageHashes": {
      "$hash": {
        ".write": "auth != null && !data.exists() && newData.val() === auth.uid",
        ".read": "auth != null"
      }
    },

    "presence": {
      "$uid": {
        ".read": "auth != null",
        ".write": "auth != null && (auth.uid === $uid || root.child('admins').child(auth.uid).val() === true)",
        ".validate": "newData.hasChildren(['name','isGuest','online','lastSeen'])"
      }
    },

    "admins": {
      ".read": "auth != null && root.child('admins').child(auth.uid).val() === true",
      ".write": "auth != null && root.child('admins').child(auth.uid).val() === true"
    },

    "userProfiles": {
      "$uid": {
        ".read": "auth != null && (auth.uid === $uid || root.child('admins').child(auth.uid).val() === true)",
        ".write": "auth != null && ((!data.exists() && auth.uid === $uid && newData.child('email').val() === auth.token.email && newData.child('createdAt').val() <= now + 5000 && newData.child('createdAt').val() >= now - 60000) || (data.exists() && auth.uid === $uid) || (root.child('admins').child(auth.uid).val() === true))",
        ".validate": "newData.hasChildren(['name','email','createdAt'])"
      }
    },

    "metadata": {
      "lastWrite": {
        "$uid": {
          ".read": "auth != null && (auth.uid === $uid || root.child('admins').child(auth.uid).val() === true)",
          ".write": "auth != null && auth.uid === $uid"
        }
      },
      "userCreation": {
        "$creator": {
          ".read": "auth != null && (auth.uid === $creator || root.child('admins').child(auth.uid).val() === true)",
          ".write": "auth != null && auth.uid === $creator"
        }
      }
    }
  }
}
